<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Dance</title>
    <link rel="shortcut icon" type="image/x-ico" href="https://www.baidu.com/favicon.ico">

    <!-- include three.js -->
    <script src="vendor/three.js/build/three.js"></script>

    <script src="vendor/three.js/examples/js/libs/mmdparser.min.js"></script>
    <script src="vendor/three.js/examples/js/libs/ammo.js"></script>
    <script src="vendor/three.js/examples/js/loaders/TGALoader.js"></script>
    <script src="vendor/three.js/examples/js/animation/MMDPhysics.js"></script>
    <script src="vendor/three.js/examples/js/animation/CCDIKSolver.js"></script>
    <script src="vendor/three.js/examples/js/effects/OutlineEffect.js"></script>
    <script src="vendor/three.js/examples/js/loaders/MMDLoader.js"></script>

    <script src="vendor/three.js/examples/js/controls/OrbitControls.js"></script>
    
    
    <!-- include js-aruco -->
    <script src='vendor/js-aruco/svd.js'></script>
    <script src='vendor/js-aruco/posit1-patched.js'></script>
    <script src='vendor/js-aruco/cv.js'></script>
    <script src='vendor/js-aruco/aruco.js'></script>
    
    <!-- include some extensions -->
    <script src='dep/threex.webcamgrabbing.js'></script>
    <script src='dep/threex.imagegrabbing.js'></script>
    <script src='dep/threex.videograbbing.js'></script>
    <script src='dep/threex.jsarucomarker.js'></script>
</head>

<body style="margin: 0px; overflow: hidden; text-align:center;">
    <div style="position:absolute; bottom:20px;">
        <button type="">弹幕</button>
    </div>
</body>
<script>
var THREE = window.THREE;

var renderer, scene, camera;
var markerObject3D;

var onRenderFcts = [];

var config = {};

var clock = new THREE.Clock();

function initScene() {
    renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // init scene and camera
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.z = 40;

    markerObject3D = new THREE.Object3D();
    scene.add(markerObject3D);

    onRenderFcts.push(function () {
        renderer.render(scene, camera);
    });
}

function initConfig() {
    config = {
        1: {
            mmd: './assets/models/miku/miku_v2.pmd',
            vmd: ['./assets/models/miku/wavefile_v2.vmd'],
            audio: './assets/sounds/wavefile_short.mp3'
        }
    }
}

function initLight() {
    // var object3d = new THREE.AmbientLight(0x101010);
    // object3d.name = 'Ambient light';
    // scene.add(object3d);
    // var object3d = new THREE.DirectionalLight('white', 0.1 * 1.6);
    // object3d.position.set(2.6, 1, 3).setLength(1);
    // object3d.name = 'Back light';
    // scene.add(object3d);

    // var object3d = new THREE.DirectionalLight('white', 0.375 * 1.6);
    // object3d.position.set(-2, -1, 0);
    // object3d.name = 'Key light';
    // scene.add(object3d);
    // var object3d = new THREE.DirectionalLight('white', 0.8 * 1);
    // object3d.position.set(3, 3, 2);
    // object3d.name = 'Fill light';
    // scene.add(object3d);

    var ambient = new THREE.AmbientLight(0x101010);
    scene.add(ambient);

    var directionalLight = new THREE.DirectionalLight('white', 0.8 * 1);
    directionalLight.position.set(-1, 1, 1).normalize();
    scene.add(directionalLight);
}

function initLogo() {
    var material = new THREE.SpriteMaterial({
        map: THREE.ImageUtils.loadTexture('./assets/images/awesome.png')
    });
    var geometry = new THREE.BoxGeometry(1, 1, 1);
    var object3d = new THREE.Sprite(material);
    object3d.scale.set(1, 1, 1).multiplyScalar(1.3);
    object3d.position.z = 1.4;
    markerObject3D.add(object3d);

    onRenderFcts.push(function (now, delta) {
        var angle = Math.PI * now / 1000;
        object3d.position.z = 1.4 + Math.cos(angle) * 0.1;

        object3d.position.x = 0 + Math.sin(angle) * 0.1;
    });
}

function initMMD() {
    var pmdFile = './assets/models/miku/miku_v2.pmd';
    var vmdFile = ['./assets/models/miku/wavefile_v2.vmd'];

    var loader = new THREE.MMDLoader();
    loader.load(pmdFile, vmdFile, function onLoad(mesh) {
        mesh.position.y = -10;
        markerObject3D.add(mesh);

        var helper = new THREE.MMDHelper();
        helper.add(mesh);
        helper.setAnimation(mesh);

        var ikHelper = new THREE.CCDIKHelper(mesh);
        ikHelper.visible = false;
        markerObject3D.add(ikHelper);

        helper.setPhysics(mesh);
        var physicsHelper = new THREE.MMDPhysicsHelper(mesh);
        physicsHelper.visible = false;
        markerObject3D.add(physicsHelper);

        helper.unifyAnimationDuration({
            afterglow: 2.0
        });

        onRenderFcts.push(function (now, delta) {
            helper.animate(clock.getDelta());
            if (physicsHelper !== undefined && physicsHelper.visible) {
                physicsHelper.update();
            }

            if (ikHelper !== undefined && ikHelper.visible) {
                ikHelper.update();
            }
        });

        initAudio();
    }, function onProgress(xhr) {
        if (xhr.lengthComputable) {
            var percentComplete = xhr.loaded / xhr.total * 100;
            console.log(Math.round(percentComplete, 2) + '% downloaded');
        }

    }, function onError(xhr) {});
}

function initStage() {
    var geometry = new THREE.PlaneGeometry(1, 1, 10, 10);
    var material = new THREE.MeshBasicMaterial({
        wireframe: true
    });
    var mesh = new THREE.Mesh(geometry, material);
    markerObject3D.add(mesh);

    var mesh = new THREE.AxisHelper();
    markerObject3D.add(mesh);
}

function initAnimate() {
    var previousTime = performance.now();
    requestAnimationFrame(function animate(now) {
        requestAnimationFrame(animate);

        onRenderFcts.forEach(function (onRenderFct) {
            onRenderFct(now, now - previousTime);
        });

        previousTime = now;
    });
}

function initWebcam() {
    var videoGrabbing = new THREEx.WebcamGrabbing();

    document.body.appendChild(videoGrabbing.domElement);
}

function initAudio() {
    var soundUrl = './assets/sounds/wavefile_short.mp3';
    var audio = new Audio(soundUrl);
    audio.play();
}

function getParamVal(str, name) {
    var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
    var r = str.match(reg);
    if (r !== null) {
        return unescape(r[2]);
    }
    return '';
}

function init() {
    initScene();
    initLight();
    // initLogo();
    initMMD();
    // initStage();

    initWebcam();

    initAnimate();

    new THREE.OrbitControls(camera, renderer.domElement);

    window.addEventListener('resize', function () {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
    }, false);
}

init();

</script>
</html>
